name: Deploy Pages from ZIP
on:
  push:
    branches: [ main ]
    paths: [ '**/*.zip' ]     # 任何 ZIP 變動就觸發
  workflow_dispatch: {}        # 可手動執行

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/configure-pages@v5

      - name: Ensure unzip exists
        run: |
          if ! command -v unzip >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y unzip
          fi

      - name: Find and unzip ZIP
        shell: bash
        run: |
          echo "== repo root =="
          ls -la

          # 優先用這次 commit 變動的 ZIP；沒有就全倉庫搜尋（不分大小寫）
          ZIP=$(git show --name-only --pretty="" "$GITHUB_SHA" | grep -Eio '[^[:space:]]+\.zip' | tail -n1)
          if [ -z "$ZIP" ]; then ZIP=$(find . -maxdepth 3 -type f -iname '*.zip' | head -n1); fi

          if [ -z "$ZIP" ]; then echo "❌ 找不到 ZIP"; exit 1; fi
          echo "Using ZIP: $ZIP"

          rm -rf dist && mkdir -p dist
          unzip -o "$ZIP" -d dist

          echo "== after unzip =="
          find dist -maxdepth 2 -type f | sed 's/^/ - /'

          # 若多包一層且內層有 index.html，就扁平化
          if [ ! -f dist/index.html ]; then
            INNER=$(find dist -mindepth 1 -maxdepth 1 -type d | head -n1 || true)
            if [ -n "$INNER" ] && [ -f "$INNER/index.html" ]; then
              echo "Flattening $INNER -> dist"
              shopt -s dotglob
              mv "$INNER"/* dist/
            fi
          fi

          touch dist/.nojekyll
          ls -la dist
          test -f dist/index.html || (echo "❌ dist/index.html 不存在" && exit 1)

      - uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - id: deployment
        uses: actions/deploy-pages@v4
